{% extends "layout.html" | front_ended %}
{% block title %}Introduction to Minargon{% endblock %}
{% block body %}
{{ super() }}

<style>
  tb. {
    width: 100%;
    border-collapse: collapse;
  }
  tb. th, tb td {text-align: left;}
</style>

<!-- <div class="col-md-8 hcenter"> -->
<div class="container">

<div class="row">
<h1>SBND Online Monitoring</h1>
</div>
<br>

<div class="row">

<div class="col-lg-3 col-md-3 col-sm-8" style="padding:0">
    <h5>External Links</h5>
    Shifter Feedback: <a href="https://docs.google.com/forms/d/e/1FAIpQLSeacwY7BIyRl7Z3bWRUjkXlYVJtcIg07pnkq0Rh1QshmJmGtg/viewform?usp=sf_link" target="_blank">click here</a>
    <br>
    Operations Wiki: <a href="https://cdcvs.fnal.gov/redmine/projects/sbnd-operations/wiki" target="_blank">click here</a>
    <br>
    BNB Status: <a href="https://dbweb8.fnal.gov:8443/ifbeam/bmon/bnbmon/Display" target="_blank">click here</a>
    <br>
    E-Log: <a href="https://dbweb0.fnal.gov/ECL/sbnd" target="_blank">click here</a>
    <br>
    <br>
    <br>

    <!-- configurable audible alarm -->
    <!-- {% set detector_value = 60 %} Get this value from the detector -->
     {% set HV_value = -1 %} <!-- HV status, initialized to stupid value -->
     {% set TPC_value = -1 %}

    <p>High Voltage Status: <span id="HVDisplayValue">{{ HV_value }}</span>; Alarm HV > 0</p>
    <span id="HVValue" HV-value="{{ HV_value }}" style="display: none;"></span>

    <p>TPC Status: <span id="TPCDisplayValue">{{ TPC_value }}</span>; Alarm TPC Status > 0</p>
    <span id="TPCValue" TPC-value="{{ TPC_value }}" style="display: none;"></span>
    <span id="isAlarmDisabled"></span> 
    <br>
    <button onclick="testAlarm()">Test Alarm</button>
    <br>
    <button onclick="disableAlarm()">Issue Acknowledged - Disable Alarm</button>
    <br>
    <span id="lastDisabledTime"></span>  <!-- Display last disabled time -->
    <br>
    <button onclick="resetAlarm()">Issue Resolved - Reset Alarm</button>
    <br>
    <span id="lastResetTime"></span>  <!-- Display last reset time -->
    
    <audio id="alarmSound" src="static/audio/0096.mp3" loop></audio>

    <script>
        let alarmTriggered = false;
        let alarmDisabled = localStorage.getItem("alarmDisabled") === "true";
        const DISABLE_DURATION =  60 * 60 * 1000; // 1 hour in milliseconds

        function formatTimestamp(timestamp) {
            if (!timestamp) return "Never";
            const date = new Date(parseInt(timestamp));
            return date.toLocaleString(); // Convert to readable format
        }

        function setIsAlarmDisabled() {
          const lastDisabled = localStorage.getItem("disableTimestamp");
          const alarmStatus = document.getElementById("isAlarmDisabled");

         if (lastDisabled) {
          alarmStatus.innerText = "Alarm Disabled";
          alarmStatus.style.color = "red"; // Set text color to red
          } else {
          alarmStatus.innerText = "Alarm Active";
          alarmStatus.style.color = "green"; // Set text color to green
          }
        }

        function updateLastDisabledTime() {
            const lastDisabled = localStorage.getItem("disableTimestamp");
            document.getElementById("lastDisabledTime").innerText = lastDisabled 
                ? `Last disabled: ${formatTimestamp(lastDisabled)}`
                : "Last disabled: Never";
        }

        function updateLastResetTime() {
            const lastReset = localStorage.getItem("resetTimestamp");
            document.getElementById("lastResetTime").innerText = lastReset
                ? `Last reset: ${formatTimestamp(lastReset)}`
                : "Last reset: Never";
        }

        function checkAutoReset() {
            const disableTimestamp = localStorage.getItem("disableTimestamp");
            if (disableTimestamp) {
                const currentTime = new Date().getTime();
                if (currentTime - disableTimestamp > DISABLE_DURATION) {
                    resetAlarm();
                    console.log("Alarm auto-reset after 1 hour");
                }
              }
        }

        function testAlarm() {
          let alarmSound = document.getElementById("alarmSound");
          alarmSound.play()
            .then(() => console.log("Test alarm playing!"))
            .catch(error => console.log("Error playing test alarm:", error));
        }

        function checkAlarm() {
            checkAutoReset();
            let HVValue = parseInt(document.getElementById("HVValue").getAttribute("HV-value"));
            let TPCValue = parseInt(document.getElementById("TPCValue").getAttribute("TPC-value"));

            if ((HVValue > 0 || TPCValue > 0 ) && !alarmTriggered && !alarmDisabled) {
                document.getElementById("alarmSound").play();
                alarmTriggered = true;
            } 
            
        }

        function disableAlarm() {
            document.getElementById("alarmSound").pause();
            alarmTriggered = false;
            alarmDisabled = true;  // Prevent alarm from playing again
            const timestamp = new Date().getTime();
            localStorage.setItem("alarmDisabled", "true");
            localStorage.setItem("disableTimestamp", timestamp);
            updateLastDisabledTime();
            setIsAlarmDisabled();
        }

        function resetAlarm() {
            alarmTriggered = false;
            alarmDisabled = false;
            const timestamp = new Date().getTime();
            localStorage.setItem("alarmDisabled", "false");
            localStorage.removeItem("disableTimestamp");
            localStorage.setItem("resetTimestamp", timestamp);
            updateLastDisabledTime();
            updateLastResetTime();
            setIsAlarmDisabled();
        }

        // Store and send the user's HV reset time
    function resetHVPoll() {
        const timestamp = new Date().getTime();

        // Store the time locally in the user's browser
        localStorage.setItem("HVResetTime", timestamp);
        console.log("Sending HV reset time:", timestamp); // Debugging log

        // Send user-specific HV start time to Flask to store in session
        fetch('/set_user_HV_start_time', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ HV_start_time: timestamp })
          })
          .then(response => {
              console.log("Fetch response status:", response.status);
              return response.json();
          })
          .then(data => {
              console.log("Server response:", data);
              if (response.ok) {
                  console.log('User-specific HV poll reset time sent successfully');
                  updateLastHVTime();
              } else {
                  console.error('Error sending HV poll reset time');
              }
          })
          .catch(error => {
              console.error('Fetch error:', error);
          });
        updateLastHVTime();
       }

        function resetHVPoll2Hr() {
          const timestamp = new Date().getTime();
          const twoHoursAgo = timestamp - 2 * 60 * 60 * 1000; // 2 hours in milliseconds
          localStorage.setItem("HVResetTime", twoHoursAgo);
          // Send to Flask via POST request
          fetch('/set_user_HV_start_time', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ HV_start_time: twoHoursAgo })
              }).then(response => {
                  if (response.ok) {
                      console.log('Start time sent successfully');
                  } else {
                      console.error('Error sending start time');
                  }
              });
              updateLastHVTime();
        }

        function formatTimestamp(timestamp) {
          if (!timestamp) return "Never";
          const date = new Date(parseInt(timestamp));
          return date.toLocaleString(); // Convert to a human-readable format
        }

        function updateLastHVTime() {
          const lastReset = localStorage.getItem("HVResetTime");
          document.getElementById("lastHVResetTime").innerText = lastReset
          ? `Last HV reset: ${formatTimestamp(lastReset)}`
          : "Last HV reset: Never";
        }

        function updateDisplay() {
        let newHVValue = document.getElementById("HVValue").getAttribute("HV-value");
        let newTPCValue = document.getElementById("TPCValue").getAttribute("TPC-value");
        document.getElementById("HVDisplayValue").innerText = newHVValue;
        document.getElementById("TPCDisplayValue").innerText = newTPCValue;
      }

      document.addEventListener("DOMContentLoaded", () => {
      setInterval(checkAlarm, 1000);  // Check every second
      updateLastDisabledTime(); // Update time on page load
      updateLastResetTime(); // Update time on page load
      updateLastHVTime();    // Ensure server-side HV reset time is displayed
      setIsAlarmDisabled();
      updateDisplay();
      fetchHVData();
      });
  </script>


</div>

<!-- <audio src="static/audio/0096.wav" autoplay></audio> -->

<div class="col-lg-3 col-md-3 col-sm-8" style="padding:0">
    <h5>Online Monitoring Wikis</h5>
    Public SBN Wiki: <a href="https://sbnsoftware.github.io/sbn_online_wiki/sbndqm_Wiki" target ="_blank">click here</a>
    <br>
    Regular Shifters: <a href="https://cdcvs.fnal.gov/redmine/projects/sbnd-operations/wiki/OnMonForShifter" target="_blank">click here</a>
    <br>
    Expert Shifters: <a href="https://cdcvs.fnal.gov/redmine/projects/sbnd-operations/wiki/OnMonExpert" target="_blank">click here</a>
    <br>
    DQM Experts: <a href = "https://cdcvs.fnal.gov/redmine/projects/sbnd/wiki/Dqmexpert" target="_blank">click here</a>
    <br>
</div>

<div class="col-lg-5 col-md-5 col-sm-12" style="padding:0">
  <h3 class="hcenter"> <a href="{{url_for('DriftHV_Heinzinger')}}">Drift HV Status ( <span id="ignition-last-update"></span> )</a></h3>
  <table class="table table-striped">
    <tr>
      <th style="width: 31%;"> Status:</a></th>
      <th><span id="DriftHV-Status"> </span></th>
    </tr>
    <tr>
      <th style="width: 41%;"> VMon alarms during past <span id="vmon_awindow"></span></a></th>
      <th> # of samples: <span id="VMon-Nsamples"> </span>
      <table>
      <tbody style="font-size: 12px";>
        <tr>
          <td style="width: 31%;"> HI: </a></td>
          <th><span id="VMon-HI"> </span></th>
          <td style="width: 31%;"> HIHI: </a></td>
          <th><span id="VMon-HIHI"> </span></th>
        </tr>
        <tr>
          <th style="width: 31%;"> LO:</a></th>
          <th><span id="VMon-LO"> </span></th>
          <th style="width: 31%;"> LOLO:</a></th>
          <th><span id="VMon-LOLO"> </span></th>
        </tr>
      </table>
      </th>
    </tr>
    <tr>
      <th style="width: 41%;"> IMon alarms during past <span id="imon_awindow"></span></a></th>
      <th> # of samples: <span id="IMon-Nsamples"> </span>
      <table>
      <tbody style="font-size: 12px";>
        <tr>
          <td style="width: 31%;"> HI: </a></td>
          <th><span id="IMon-HI"> </span></th>
          <td style="width: 31%;"> HIHI: </a></td>
          <th><span id="IMon-HIHI"> </span></th>
        </tr>
        <tr>
          <th style="width: 31%;"> LO:</a></th>
          <th><span id="IMon-LO"> </span></th>
          <th style="width: 31%;"> LOLO:</a></th>
          <th><span id="IMon-LOLO"> </span></th>
        </tr>
      </table>
      </th>
    </tr>
    <button onclick="resetHVPoll()">Reset HV Poll Window</button>
    <br>
    <span id="lastHVResetTime"></span>  <!-- Display last reset time -->
    <br>
    <button onclick="resetHVPoll2Hr()">2 Hour HV Poll Window</button>
  </table>
</div>

</div>

<br>
<br>

<div class="row">
<div class="col-lg-5 col-md-5 col-sm-12" style="padding:0">
  <h3 class="hcenter"> DQM Status </h3>
  <table class="table table-striped">
  <tr>
	  <th>Redis DB memory usage: </th>
	  <th><span id="redis-mem"><span id="redis-mem-GB"> </span>GB / <span id="redis-mem-percent"> </span>%</span></th>
	</tr>
	<tr>
	  <th>DQM Archiver: </th>
	  <th><span id="archiver-ping"></span></th>
	</tr>
  <tr>
    <th>DCS Archiver: </th>
    <th><A HREF=/sbnd/dcs/ target="_blank">Click Here</A></th>
  </tr>
  </table>
</div>

<div class="hcenter col-lg-5 col-md-5 col-sm-12" style="padding:0">
  <h3 class="hcenter">Detector Status </h3>
  <h5>Run: <span id="run-number"></span>, Timestamp: <span id="timestamp"></span></h5>
  <table class="table table-striped">
  <tr>
    <th style="width: 31%;"><a href="{{url_for('TPC_status')}}">TPC Status:</a></th>
    <th><span id="TPC-Status"> </span></th>
  </tr>
  <tr>
    <th style="width: 31%;"><a href="{{url_for('PMT_status')}}">PMT Status:</a></th>
    <th><span id="PMT-Status"> </span></th>
  </tr>
  <tr>
    <th style="width: 31%;"><a href="{{url_for('CRT_status')}}">CRT Status:</a></th>
    <th><span id="CRT-Status"> </span></th>
  </tr>
  <tr>
    <th style="width: 31%;"><a href="{{url_for('PTB_status')}}">Trigger Status:</a></th>
    <th><span id="Trigger-Status"> </span></th>
  </tr>
  <tr>
    <th style="width: 31%;"><a href="{{url_for('Timing_status')}}">Timing Status:</a></th>
    <th><span id="Timing-Status"> </span></th>
  </tr>
  </table>
</div>
</div>

{%endblock%}


{% block script %}
<script defer type="module">
import * as Config from "{{ url_for('static', filename='js/minargon/config.js') }}";
import * as Data from "{{ url_for('static', filename='js/minargon/Data.js') }}";
import * as DataLink from "{{ url_for('static', filename='js/minargon/DataLink.js') }}";
import * as Poll from "{{ url_for('static', filename='js/minargon/poll.js') }}";
import {throw_database_error} from "{{ url_for('static', filename='js/minargon/error.js') }}";

// monitor DAQConsumer
var timeout = 5 * 1000; // ms

function time_delta(earlier) {
  var now = moment(new Date).tz("America/Chicago").unix() * 1000. /* s -> ms */;
  return Math.max(0, now - earlier);
}

function is_recent(time, time_is_ok) {
  return time_delta(time) < time_is_ok;
}


function update_is_recent(data_link, spanid, time_is_ok) {
  data_link.get_data(function(err, data) {
    if (err) {
      throw_database_error(err, "update_heartbeat: " + data_link.accessors()[0][0]);
      return;
    }

    var datalist = data.values[data_link.accessors()[0][0]];
    var recent;
    var delta_str = "";
    
    if (datalist.length == 0) {
      recent = false;
    }
    else {
      recent = is_recent(datalist[datalist.length-1][0], time_is_ok);
      var delta = (time_delta(datalist[datalist.length-1][0]) / 1000.).toFixed(0);
      delta_str = " (" + String(delta) + "s)";
    }
    if (recent) {
      $(spanid).text("ON" + delta_str);
      $(spanid).css({"color": "green"});
    }
    else {
      $(spanid).text("OFF" + delta_str);
      $(spanid).css({"color": "red"});
    }
    setTimeout(function() {update_is_recent(data_link, spanid, time_is_ok);}, timeout);
  });

}


var data_link_ar = new Data.D3DataLink(new DataLink.SingleStreamLink($SCRIPT_ROOT + "/online", "archiver_heartbeat"));
update_is_recent(data_link_ar, "#AR-status", 120 * 1000 /* ms */);

var data_link_om = new Data.D3DataLink(new DataLink.SingleStreamLink($SCRIPT_ROOT + "/online", "DAQConsumer")); 
update_is_recent(data_link_om, "#OM-status", 120 * 1000 /* ms*/);


var poll_redis_mem_gb = new Poll.Poll($SCRIPT_ROOT + "/online/total_memory_usage");
poll_redis_mem_gb.add_callback(function(data) {
    if (!data || !data.val) return;
    var spanid = "#redis-mem-GB";
    $(spanid).text((data.val / (1024 * 1024 * 1024)).toFixed(2));
});
poll_redis_mem_gb.run();

var poll_redis_mem_frac = new Poll.Poll($SCRIPT_ROOT + "/online/total_memory_usage_fraction");
poll_redis_mem_frac.add_callback(function(data) {
    if (!data || !data.val) return;
    var spanid = "#redis-mem-percent";
    $(spanid).text((data.val * 100).toFixed(2));

    spanid = "#redis-mem";
    if (data.val > 0.85) {     $(spanid).css({"color": "red"});
    }
    else {
      $(spanid).css({"color": "green"});
    }
   
});
poll_redis_mem_frac.run();


var poll_ignition_ping = new Poll.Poll($SCRIPT_ROOT + "/ping_ignition");
poll_ignition_ping.add_callback(function(data) {
    var delta_ignition = time_delta(data[1]*1000.);
    var delta_str_ignition = " (" + String(delta_ignition) + "s)";
    var spanid = "#ignition-last-update";
    $(spanid).text("Last update: " + delta_str_ignition);
    if (delta_ignition < 60) {
      $(spanid).css({"color": "green"})
    }
    if (delta_ignition > 60) {
      if (delta_ignition < 120) {
        $(spanid).css({"color": "orange"})
      }
      else {
        $(spanid).css({"color": "red"})
      }
    }

});
poll_ignition_ping.run();

var poll_archiver_ping = new Poll.Poll($SCRIPT_ROOT + "/ping_archiver");
poll_archiver_ping.add_callback(function(data) {
    var delta_archiver = time_delta(data[1]*1000.);
    var delta_str_archiver = " (" + String(delta_archiver) + "s)";
    var spanid = "#archiver-ping";
    if (data[0] == "True") {
      $(spanid).css({"color": "green"})
      $(spanid).text("Connected" + delta_str_archiver);
    }
    else {
      $(spanid).css({"color": "red"})
      $(spanid).text("disconneted" + delta_str_archiver);
    }

});
poll_archiver_ping.run();

// Placeholders for detector status until we have a real status criteria
$("#PMT-Status").text("need alarm limits");
$("#PMT-Status").css({"color": "orange"});

$("#Trigger-Status").text("need alarm limits");
$("#Trigger-Status").css({"color": "orange"});

$("#Timing-Status").text("need alarm limits");
$("#Timing-Status").css({"color": "orange"});

// Drift HV
// current status
var BAD_DRIFTHVS = new Set();
var bad_drifthv_pvs = {{bad_drifthv_pvs|tojson|safe}};
{% for pv in bad_drifthv_pvs %}
{ BAD_DRIFTHVS.add("{{pv}}"); }
{% endfor %}
var HV_status = 0;
if (BAD_DRIFTHVS.size > 0) {
  HV_status = 1;
}

let awindow_str = "{{awindow}}";
$("#vmon_awindow").html(awindow_str);
$("#imon_awindow").html(awindow_str);
//vmon log
var vmon_status = 0;
$("#VMon-Nsamples").html({{vmon_nsamples}});

let vmon_hi_str = "{{vmon_hi}}";
$("#VMon-HI").html(vmon_hi_str);
$("#VMon-HI").css({"color": "green"});
if ( {{vmon_hi}} >  0.005*{{vmon_nsamples}}) {
  $("#VMon-HI").css({"color": "orange"});
}
if ( {{vmon_hi}} >  0.01*{{vmon_nsamples}}) {
  $("#VMon-HI").css({"color": "red"});
  HV_status = 1;
}

let vmon_hihi_str = "{{vmon_hihi}}";
$("#VMon-HIHI").html(vmon_hihi_str);
if (( {{vmon_hihi}} > 0) || ( {{vmon_hihi}} < 5)) {
  $("#VMon-HIHI").css({"color": "orange"});
}
if ( {{vmon_hihi}} > 5 ) {
  $("#VMon-HIHI").css({"color": "red"});
  HV_status = 1;
}
if ( {{vmon_hihi}} == 0) {
  $("#VMon-HIHI").css({"color": "green"});
}

let vmon_lo_str = "{{vmon_lo}}";
$("#VMon-LO").html(vmon_lo_str);
$("#VMon-LO").css({"color": "green"});
if ( {{vmon_lo}} >  0.005*{{vmon_nsamples}}) {
  $("#VMon-LO").css({"color": "orange"});
}
if ( {{vmon_lo}} >  0.01*{{vmon_nsamples}}) {
  $("#VMon-LO").css({"color": "red"});
  HV_status = 1;
}

let vmon_lolo_str = "{{vmon_lolo}}";
$("#VMon-LOLO").html(vmon_lolo_str);
if (( {{vmon_lolo}} > 0) || ( {{vmon_lolo}} < 5)) {
  $("#VMon-LOLO").css({"color": "orange"});
}
if ( {{vmon_lolo}} > 5 ) {
  $("#VMon-LOLO").css({"color": "red"});
  HV_status = 1;
}
if ( {{vmon_lolo}} == 0) {
  $("#VMon-LOLO").css({"color": "green"});
}

//imon log
$("#IMon-Nsamples").html({{imon_nsamples}});

let imon_hi_str = "{{imon_hi}}";
$("#IMon-HI").html(imon_hi_str);
$("#IMon-HI").css({"color": "green"});
if ( {{imon_hi}} >  0.025*{{imon_nsamples}}) {
  $("#IMon-HI").css({"color": "orange"});
}
if ( {{imon_hi}} >  0.05*{{imon_nsamples}}) {
  $("#IMon-HI").css({"color": "red"});
  HV_status = 1;
}

let imon_hihi_str = "{{imon_hihi}}";
$("#IMon-HIHI").html(imon_hihi_str);
if (( {{imon_hihi}} > 0) || ( {{imon_hihi}} < 5)) {
  $("#IMon-HIHI").css({"color": "orange"});
}
if ( {{imon_hihi}} > 5 ) {
  $("#IMon-HIHI").css({"color": "red"});
  HV_status = 1;
}
if ( {{imon_hihi}} == 0) {
  $("#IMon-HIHI").css({"color": "green"});
}

let imon_lo_str = "{{imon_lo}}";
$("#IMon-LO").html(imon_lo_str);
$("#IMon-LO").css({"color": "green"});
if ( {{imon_lo}} >  0.05*{{imon_nsamples}}) {
  $("#IMon-LO").css({"color": "orange"});
}
if ( {{imon_lo}} >  0.025*{{imon_nsamples}}) {
  $("#IMon-LO").css({"color": "red"});
  HV_status = 1;
}

let imon_lolo_str = "{{imon_lolo}}";
$("#IMon-LOLO").html(imon_lolo_str);
if (( {{imon_lolo}} > 0) || ( {{imon_lolo}} < 5)) {
  $("#IMon-LOLO").css({"color": "orange"});
}
if ( {{imon_lolo}} > 5 ) {
  $("#IMon-LOLO").css({"color": "red"});
  HV_status = 1;
}
if ( {{imon_lolo}} == 0) {
  $("#IMon-LOLO").css({"color": "green"});
}

if (HV_status == 1) {
  let bad_drifthvs_str = "NOT OK";
  $("#DriftHV-Status").html(bad_drifthvs_str);
  $("#DriftHV-Status").css({"color": "red"});
}
else {
  $("#DriftHV-Status").text("OK");
  $("#DriftHV-Status").css({"color": "green"});
}

//For audible alarm

document.getElementById("HVValue").setAttribute("HV-value", HV_status);
updateDisplay();


// TPCs
var BAD_PLANES = new Set();
var TPC_ON = false;
var short_chs = {{ short_chs }};
var dead_chs = {{ dead_chs }};
var TPC_status = 0;
{% for tpc_plane in tpc_planes %}
  {% set tpc_channels = tpc_channels[loop.index0]|tojson %}
  {% set tpc_title = tpc_titles[loop.index0] %}
  {
  var tpc_config_controller = new Config.GroupConfigController({{tpc_config|tojson|safe}}, undefined, ["rms"], {{tpc_channels}}, 0, 25, "", undefined, "");
  var tpc_data_link = tpc_config_controller.data_link(0, ["rms"], undefined, 1);
  var tpc_poll = new Data.D3DataPoll(tpc_data_link, 60000);
  var tpc_buffer = new Data.D3DataBuffer(tpc_poll, 1, [
    function(data) {
      TPC_ON = false;
      var ch = {{tpc_channels}}
      var rms_data = data;
      var nch_zerorms = 0;
      var plane_has_bad_rms = false;

      for (var i = 0; i < rms_data.length; i++) {
        var rms = rms_data[i].get_last()[1]; //get the last value of rms for channel i
       
        if (!TPC_ON && rms > 0) {
          TPC_ON = true; //if any channel has data, the TPC is on
        }
       
        // Skip the max rms requirement for noisy wires on west induction planes
        var skip1 = short_chs.includes(ch[i]);
        if (!skip1 && rms > {{ tpc_rms_max }}) {
            plane_has_bad_rms = true;
            break; // Exit the loop early since we found a bad RMS value
        }

        // Skip the 0 rms requirement for wires connected to shorted FEM
	var skip2 = dead_chs.includes(ch[i]);
	if (!skip2 && rms === 0) {
            nch_zerorms++;
        }

      }//end for over channel RMS values

      if (plane_has_bad_rms || nch_zerorms > 10) {
        BAD_PLANES.add('{{ tpc_title }}');
      }
      else {
        BAD_PLANES.delete('{{ tpc_title }}');
      }
      if (!TPC_ON) {
	      $("#TPC-Status").text("NO DATA");
        $("#TPC-Status").css({"color": "orange"});
      } 
      else if (BAD_PLANES.size > 0) {
        let bad_planes_str = "NOT OK."+"<a href={{url_for('TPC_metrics_per_plane')}}>Bad Planes: </a>" + Array.from(BAD_PLANES).sort().join(", ");
        $("#TPC-Status").html(bad_planes_str);
        $("#TPC-Status").css({"color": "red"});
      }
      else {
        $("#TPC-Status").text("OK");
        $("#TPC-Status").css({"color": "green"});
      }  
    }
  ]);
  tpc_buffer.start();
  }
{% endfor %}

//For audible alarm
if (TPC_ON) {TPC_status = BAD_PLANES.size;} //else TPC_status = 0;
document.getElementById("TPCValue").setAttribute("TPC-value", TPC_status);
updateDisplay();


//CRTs
var baseline_sum = 0;
var BAD_CRTS = new Set();
var crt_config = {{crt_config|tojson|safe}};

{% for crt in crts %}
  {% set crt_channels = crt_channels[loop.index0]|tojson %}
  {
  var crt_config_controller = new Config.GroupConfigController(crt_config, undefined, ["baseline"], {{crt_channels}}, 0, 25, "", undefined, undefined);
  var crt_data_link = crt_config_controller.data_link(0, ["baseline"], undefined, 1);
  var crt_poll = new Data.D3DataPoll(crt_data_link, 60*1000 /* 1 minute */);
  var crt_buffer = new Data.D3DataBuffer(crt_poll, 1, [
    function(data) {
      
      var crt_channels = {{crt_channels}};
      var baseline_data = data;

      for (var i = 0; i < crt_channels.length; i++) {
        if (baseline_data[i].size > 0) {
          var baseline = baseline_data[i].get_last()[1];
          baseline_sum += baseline;
        }

        if ( (baseline < {{crt_baseline_min}}) || (baseline > {{crt_baseline_max}}) )
        {
          var channel_str = String(crt_channels[i]);
          BAD_CRTS.add(channel_str);
        }
      }

      if (baseline_sum == 0){
        $("#CRT-Status").text("NO DATA");
        $("#CRT-Status").css({"color": "orange"});
      }
      else if (BAD_CRTS.size > 0) {
        let bad_crts_str = "NOT OK. Bad boards: " + Array.from(BAD_CRTS).join(" ");
        $("#CRT-Status").html(bad_crts_str);
        $("#CRT-Status").css({"color": "orange"});
      }
      else {
        $("#CRT-Status").text("OK");
        $("#CRT-Status").css({"color": "green"});
      }
    }
  ]);
  crt_buffer.start();
  }
{% endfor %}

//PMTs
var baseline_sum = 0;
var BAD_PMTS = new Set();
var pmt_config = {{pmt_config|tojson|safe}};

{% for pmt in pmts %}
  {% set pmt_channels = pmt_channels[loop.index0]|tojson %}
  {
  var pmt_config_controller = new Config.GroupConfigController(pmt_config, undefined, ["rms", "baseline"], {{pmt_channels}}, 0, 25, "", undefined, undefined);
  var pmt_data_link = pmt_config_controller.data_link(0, ["rms", "baseline"], undefined, 1);
  var pmt_poll = new Data.D3DataPoll(pmt_data_link, 60*1000 /* 1 minute */);
  var pmt_buffer = new Data.D3DataBuffer(pmt_poll, 1, [
    function(data) {
      var badPMTs = [];
      var pmt_channels = {{pmt_channels}};
      var rms_data = data.slice(0, pmt_channels.length);
      var baseline_data = data.slice(pmt_channels.length);

      var baselines = [];
      var rmss = [];
      var baseline_sum = 0;

      for (var i = 0; i < pmt_channels.length; i++) {
      
        var this_baseline_data = baseline_data[i];
        var baseline = 0.;
        for (var j = 0; j < this_baseline_data.size; j++) {
          var baseline = baseline + this_baseline_data.get(j)[1]/this_baseline_data.size ;
        }

        var this_rms_data = rms_data[i];
        var rms = 0.;
        for (var j = 0; j < this_rms_data.size; j++) { 
          rms = rms + this_rms_data.get(j)[1] / this_rms_data.size;
        }
            
  
        baselines.push(baseline);
        rmss.push(rms);
        baseline_sum += baseline;

        var bad = (this_rms_data.size > 0) && ( (baseline < {{pmt_baseline_min}}) || (baseline > {{pmt_baseline_max}}) || (rms < {{pmt_rms_min}}) || (rms > {{pmt_rms_max}}));
        
        if (bad && i < 120)  { // only 120 channels, the rest above are clock channels
          badPMTs.push(i);
        }
      }

      if (baseline_sum == 0){
        $("#PMT-Status").text("NO DATA");
        $("#PMT-Status").css({"color": "orange"});
      }
      else if (BAD_PMTS.size > 0) {
        let bad_pmts_str = "NOT OK. Bad boards: " + Array.from(BAD_PMTS).join(" ");
        $("#PMT-Status").html(bad_pmts_str);
        $("#PMT-Status").css({"color": "orange"});
      }
      else {
        $("#PMT-Status").text("OK");
        $("#PMT-Status").css({"color": "green"});
      }
    }
  ]);
  pmt_buffer.start();
  }
{% endfor %}

// Timing
var timing_config = {{timing_config|tojson|safe}};
var timing_metrics = {{timing_metrics|tojson|safe}};
var timing_channels = undefined;
var bad_timing = [];

{% for i in range(3) %}
  {
  {% for metric in timing_metrics[i] %}
  {

  var metric = {{ metric|tojson }};
  var config_controller = new Config.GroupConfigController(timing_config, undefined, [metric], [{{i}}], 0, 10)
  var data_link = config_controller.data_link(0, [metric], undefined, 1);

  var poll = new Data.D3DataPoll(data_link, 10*60*1000 /* 10 minutes */);
  var buffer = new Data.D3DataBuffer(poll, 5, [ // last parameter is number of events to use
    function(data) {
      var timing_data = data;
      for (var i = 0; i < timing_data.length; i++) {
	      var timing = timing_data[i].get_last()[1];
        if (timing < {{timing_alarms_min[i]}} || timing > {{timing_alarms_max[i]}}) {
          bad_timing.push(i);
        }
      }
    }
  ]);
  buffer.start();
  }
  {% endfor %}
}
{% endfor %}

if (bad_timing.length > 0) {
  let bad_timing_str = "NOT OK. Bad channels: " + Array.from(bad_timing).join(" ");
  $("#Timing-Status").html(bad_timing_str);
  $("#Timing-Status").css({"color": "orange"});
}
else {
  $("#Timing-Status").text("OK");
  $("#Timing-Status").css({"color": "green"});
}


// check if metadata time is recent
var poll = new Poll.Poll($SCRIPT_ROOT + "/online/hget/eventmeta/run,subrun,event,time");
poll.add_callback(function(data) {
    var run = data.run;
    //$("#run-number").html(data.run);
    var time = moment(new Date(parseInt(data.time)));
    //$("#timestamp").html(time.format("MM/DD HH:mm:ss"));
    var dqm_recent = is_recent(time, 300*1000);
    var delta = (time_delta(time) / 1000.).toFixed(0);
    if (!dqm_recent) {
      $("#TPC-Status").text("Disconnected (" + delta + "s)");
      $("#TPC-Status").css({"color": "orange"});
      $("#CRT-Status").text("Disconnected (" + delta + "s)");
      $("#CRT-Status").css({"color": "orange"});
    }
});
poll.run();

// check if PMT metadata time is recent
var poll = new Poll.Poll($SCRIPT_ROOT + "/online/hget/eventmetaPMT/run,subrun,event,time");
poll.add_callback(function(data) {
    var PMTrun = data.run;
    var PMTtime = moment(new Date(parseInt(data.time)));
    //if (PMTtime > time) {
    //  run = PMTrun;
    //  time = PMTtime;
    //}
    $("#run-number").html(data.run);
    $("#timestamp").html(PMTtime.format("MM/DD HH:mm:ss"));
    var dqm_recent = is_recent(time, 300*1000);
    var delta = (time_delta(time) / 1000.).toFixed(0);
    if (!dqm_recent) {
      $("#PMT-Status").text("Disconnected (" + delta + "s)");
      $("#PMT-Status").css({"color": "orange"});
    }
});
poll.run();

</script> 
<meta http-equiv="refresh" content="30">
{%endblock%}
