{% extends "layout.html" | front_ended %}
{% block title %}Introduction to Minargon{% endblock %}
{% block body %}
{{ super() }}
<!-- <div class="col-md-8 hcenter"> -->
<div class="container">

<div class="row">
<h1>SBND Online Monitoring</h1>
</div>
<br>
<h3> External Links </h3>
<p>
shifter feedback: <a href="https://docs.google.com/forms/d/e/1FAIpQLSeacwY7BIyRl7Z3bWRUjkXlYVJtcIg07pnkq0Rh1QshmJmGtg/viewform?usp=sf_link" target="_blank">click here</a>
<br>
operations wiki: <a href="https://cdcvs.fnal.gov/redmine/projects/sbnd-operations/wiki" target="_blank">click here</a>
<br>
BNB Status: <a href="https://dbweb8.fnal.gov:8443/ifbeam/bmon/bnbmon/Display" target="_blank">click here</a>
<br>
E-Log: <a href="https://dbweb0.fnal.gov/ECL/sbnd" target="_blank">click here</a>
</p>
<br>

<div class="row">
<div class="col-lg-5 col-md-5 col-sm-12" style="padding:0">
  <h3 class="hcenter"> DQM Status </h3>
  <table class="table table-striped">
        <tr>
	  <th>Redis DB memory usage: </th>
	  <th><span id="redis-mem"><span id="redis-mem-GB"> </span>GB / <span id="redis-mem-percent"> </span>%</span></th>
	</tr>
	<tr>
	  <th>Redis DB connection: </th>
	  <th><span id="redis-ping"></span></th>
	</tr>
	<tr>
	  <th>Cryo DB connection: </th>
	  <th><span id="ignition-ping"></span></th>
	</tr>
      <tr>
        <th>DAQConsumer: </th>
        <th><span id="OM-status"> </span></th>
    </tr>
  </table>
</div>

<div class="hcenter col-lg-5 col-md-5 col-sm-12" style="padding:0">
  <h3 class="hcenter">Detector Status</h3>
  <table class="table table-striped">
  <tr>
    <th><a href="{{url_for('TPC_status')}}">TPC Status:</a></th>
    <th><span id="TPC-Status"> </span></th>
  </tr>
  <tr>
    <th><a href="{{url_for('DriftHV_Heinzinger')}}">Drift HV Status:</a></th>
    <th><span id="DriftHV-Status"> </span></th>
  </tr>
  <tr>
    <th><a href="{{url_for('PMT_status')}}">PMT Status:</a></th>
    <th><span id="PMT-Status"> </span></th>
  </tr>
  <tr>
    <th><a href="{{url_for('CRT_status')}}">CRT Status:</a></th>
    <th><span id="CRT-Status"> </span></th>
  </tr>
  <tr>
    <th><a href="{{url_for('PTB_status')}}">Trigger Status:</a></th>
    <th><span id="Trigger-Status"> </span></th>
  </tr>
  </table>
</div>

</div>

{%endblock%}


{% block script %}
<script defer type="module">
import * as Config from "{{ url_for('static', filename='js/minargon/config.js') }}";
import * as Data from "{{ url_for('static', filename='js/minargon/Data.js') }}";
import * as DataLink from "{{ url_for('static', filename='js/minargon/DataLink.js') }}";
import * as Poll from "{{ url_for('static', filename='js/minargon/poll.js') }}";
import {throw_database_error} from "{{ url_for('static', filename='js/minargon/error.js') }}";

// monitor DAQConsumer
var timeout = 5 * 1000; // ms

function time_delta(earlier) {
  var now = moment(new Date).tz("America/Chicago").unix() * 1000. /* s -> ms */;
  return Math.max(0, now - earlier);
}

function is_recent(time, time_is_ok) {
  return time_delta(time) < time_is_ok;
}


function update_is_recent(data_link, spanid, time_is_ok) {
  data_link.get_data(function(err, data) {
    if (err) {
      throw_database_error(err, "update_heartbeat: " + data_link.accessors()[0][0]);
      return;
    }

    var datalist = data.values[data_link.accessors()[0][0]];
    var recent;
    var delta_str = "";
    
    if (datalist.length == 0) {
      recent = false;
    }
    else {
      recent = is_recent(datalist[datalist.length-1][0], time_is_ok);
      var delta = (time_delta(datalist[datalist.length-1][0]) / 1000.).toFixed(0);
      delta_str = " (" + String(delta) + "s)";
    }
    if (recent) {
      $(spanid).text("ON" + delta_str);
      $(spanid).css({"color": "green"});
    }
    else {
      $(spanid).text("OFF" + delta_str);
      $(spanid).css({"color": "red"});
    }
    setTimeout(function() {update_is_recent(data_link, spanid, time_is_ok);}, timeout);
  });

}


var data_link_ar = new Data.D3DataLink(new DataLink.SingleStreamLink($SCRIPT_ROOT + "/online", "archiver_heartbeat"));
update_is_recent(data_link_ar, "#AR-status", 120 * 1000 /* ms */);

var data_link_om = new Data.D3DataLink(new DataLink.SingleStreamLink($SCRIPT_ROOT + "/online", "DAQConsumer")); 
update_is_recent(data_link_om, "#OM-status", 120 * 1000 /* ms*/);


var poll_redis_ping = new Poll.Poll($SCRIPT_ROOT + "/online/ping_redis");
poll_redis_ping.add_callback(function(data) {
    var spanid = "#redis-ping";
    if (data == "True") {
      $(spanid).css({"color": "green"})
      $(spanid).text("ON");
    }
    else {
      $(spanid).css({"color": "red"})
      $(spanid).text("OFF");
    }

});
poll_redis_ping.run();

var poll_redis_mem_gb = new Poll.Poll($SCRIPT_ROOT + "/online/total_memory_usage");
poll_redis_mem_gb.add_callback(function(data) {
    if (!data || !data.val) return;
    var spanid = "#redis-mem-GB";
    $(spanid).text((data.val / (1024 * 1024 * 1024)).toFixed(2));
});
poll_redis_mem_gb.run();

var poll_redis_mem_frac = new Poll.Poll($SCRIPT_ROOT + "/online/total_memory_usage_fraction");
poll_redis_mem_frac.add_callback(function(data) {
    if (!data || !data.val) return;
    var spanid = "#redis-mem-percent";
    $(spanid).text((data.val * 100).toFixed(2));

    spanid = "#redis-mem";
    if (data.val > 0.85) {     $(spanid).css({"color": "red"});
    }
    else {
      $(spanid).css({"color": "green"});
    }
   
});
poll_redis_mem_frac.run();

var poll_ignition_ping = new Poll.Poll($SCRIPT_ROOT + "/ping_ignition");
poll_ignition_ping.add_callback(function(data) {
    var spanid = "#ignition-ping";
    if (data == "True") {
      $(spanid).css({"color": "green"})
      $(spanid).text("ON");
    }
    else {
      $(spanid).css({"color": "red"})
      $(spanid).text("OFF");
    }

});
poll_ignition_ping.run();

// Placeholders for detector status until we have a real status criteria
$("#TPC-Status").text("need alarm limits");
$("#TPC-Status").css({"color": "orange"});

$("#PMT-Status").text("need alarm limits");
$("#PMT-Status").css({"color": "orange"});

$("#Trigger-Status").text("need alarm limits");
$("#Trigger-Status").css({"color": "orange"});

// Drift HV
var BAD_DRIFTHVS = new Set();
var bad_drifthv_pvs = {{bad_drifthv_pvs|tojson|safe}};
{% for pv in bad_drifthv_pvs %}
{ BAD_DRIFTHVS.add("{{pv}}"); }
{% endfor %}
if (BAD_DRIFTHVS.size > 0) {
  let bad_drifthvs_str = "NOT OK. Bad PVs: " + Array.from(BAD_DRIFTHVS).join(" ");
  $("#DriftHV-Status").html(bad_drifthvs_str);
  $("#DriftHV-Status").css({"color": "red"});
}
else {
  $("#DriftHV-Status").text("OK");
  $("#DriftHV-Status").css({"color": "green"});
}

//CRTs

var baseline_sum = 0;
var BAD_CRTS = new Set();
var crt_config = {{config|tojson|safe}};

{% for crt in crts %}
{% set crt_channels = channels[loop.index0]|tojson %}
{

var crt_config_controller = new Config.GroupConfigController(crt_config, undefined, ["baseline"], {{crt_channels}}, 0, 25, "", undefined, undefined);

var crt_data_link = crt_config_controller.data_link(0, ["baseline"], undefined, 1);
var crt_poll = new Data.D3DataPoll(crt_data_link, 60*1000 /* 1 minute */);
var crt_buffer = new Data.D3DataBuffer(crt_poll, 1, [
  function(data) {
    
    var crt_channels = {{crt_channels}};
    var baseline_data = data;

    for (var i = 0; i < crt_channels.length; i++) {

      if (baseline_data[i].size > 0) {
        var baseline = baseline_data[i].get_last()[1];
        baseline_sum += baseline;
      }


      if ( (baseline < {{baseline_min}}) || (baseline > {{baseline_max}}) )
      {
        var channel_str = String(crt_channels[i]);
        BAD_CRTS.add(channel_str);
      }

    }

    if (baseline_sum == 0){
      $("#CRT-Status").text("CRT DAQ disconnected from DQM");
      $("#CRT-Status").css({"color": "orange"});
    }
    else if (BAD_CRTS.size > 0) {
      let bad_crts_str = "NOT OK. Bad channels: " + Array.from(BAD_CRTS).join(" ");
      $("#CRT-Status").html(bad_crts_str);
      $("#CRT-Status").css({"color": "red"});
    }
    else {
      $("#CRT-Status").text("OK");
      $("#CRT-Status").css({"color": "green"});
    }
  }
]);
crt_buffer.start();
}
{% endfor %}
</script> 
<meta http-equiv="refresh" content="30">
{%endblock%}
