{% import "stream_options_macro.html" | common as stream_options %}

{% extends "layout.html" | front_ended %}
{% block title %}{{title}}{% endblock %}
{% block body %}
{{ super() }}
<div class="container">
{% if eventmeta_key %}
<div class="row">
<table class="hcenter" style="width: 50%; text-align: center;">
  <tr>
    <th>Run: <span id="run-number"></span></th>
    <th>Subrun: <span id="subrun-number"></span></th>
    <th>Event: <span id="event-number"></span></th>
    <th>Timestamp: <span id="timestamp"></span></th>
  </tr>
</table>
</div>
{% endif %}

<h1> {{title}} </h1>

<div class="container">
<h3>Beam</h3>
<div class="col-lg-8 col-md-8 col-sm-6 vcenter order-2 hcenter">
  <div class="card">
    <div class="card-header">TimeSeries Options</div>
    <div class="card-body">
      <form class="form" role="form">
          {{ stream_options.time_range("start", "end", "toggle") }}
          {{ stream_options.download("download") }}
      </form>
    </div>
  </div>
</div>
{% for this_metric in metrics[0] %}
{% if loop.index0 % 2 == 0 %}
  <div class="row">
{% endif %}
      <div class="col-lg-6 col-md-6 order-1" style="padding:0">
        <div id ="timeseries-0-{{loop.index0}}"></div>
      </div>
    {% if loop.index0 % 2 == 1 %}
  </div>
{% endif %}
{% endfor %}
</div>

<br>

<div class="container">
<h3>Off Beam</h3>
<br>
{% for this_metric in metrics[1] %}
{% if loop.index0 % 2 == 0 %}
  <div class="row">
{% endif %}
      <div class="col-lg-6 col-md-6 order-1" style="padding:0">
        <div id ="timeseries-1-{{loop.index0}}"></div>
      </div>
    {% if loop.index0 % 2 == 1 %}
  </div>
{% endif %}
{% endfor %}
</div>

<br>
<div class="container">
<h3>Crossing Muons</h3>
<br>
{% for this_metric in metrics[2] %}
{% if loop.index0 % 2 == 0 %}
  <div class="row">
{% endif %}
      <div class="col-lg-6 col-md-6 order-1" style="padding:0">
        <div id ="timeseries-2-{{loop.index0}}"></div>
      </div>
    {% if loop.index0 % 2 == 1 %}
  </div>
{% endif %}
{% endfor %}
</div>
<br>


{%endblock%}
{% block script %}
<script defer type="module">
import * as Config from "{{ url_for('static', filename='js/minargon/config.js') }}";
import * as Poll from "{{ url_for('static', filename='js/minargon/poll.js') }}";

var config = {{config|tojson|safe}};
var channels = undefined;

{% for i in range(3) %}
  {% for metric in metrics[i] %}
  var metric = {{ metric|tojson }};
  var config_controller = new Config.GroupConfigController(config, {{link_function}}, [metric], [{{i}}], 0, 10)
      .streamController("#form-stream"); 

  var plotly = config_controller.addPlotlyController("timeseries-{{i}}-{{loop.index0}}")
     .timeRangeController("#start", "#end", "#toggle")
     .downloadDataController("#download");

  config_controller.runAll();
  {% endfor %}
{% endfor %}


// setup polling for event/run/subrun/time
{% if eventmeta_key %}
var poll = new Poll.Poll($SCRIPT_ROOT + "/online/hget/{{eventmeta_key}}/run,subrun,event,time");
poll.add_callback(function(data) {
    $("#run-number").html(data.run);
    $("#subrun-number").html(data.subrun);
    $("#event-number").html(data.event);
    var time = moment(new Date(parseInt(data.time)));
    $("#timestamp").html(time.format("MM/DD HH:mm:ss"));
});
poll.run();
{% endif %}

</script>
{% endblock %}
